openapi: 3.1.0
info:
  description: "Операции, требующие идентификатор аккаунта, извлекают идентификато\
    р из токена авторизации."
  title: Provve API
  version: beta
servers:
  - url: http://localhost/api/v1
  - url: https://provve.tech/api/v1
tags:
  - name: accounts
  - name: notifications
  - name: skills
  - name: votes
  - name: sessions
paths:
  /accounts:
    post:
      requestBody:
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/_accounts_post_request"
        required: true
      responses:
        "200":
          description: Успешная регистрация
        "409":
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Notification"
          description: Пользователь уже существует
      security:
        - bearerAuth: [ ]
      summary: Регистрация пользователя
      tags:
        - accounts
      x-content-type: application/json
      x-accepts:
        - application/json
  /auth:
    get:
      requestBody:
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/_auth_get_request"
        required: true
      responses:
        "200":
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/_auth_get_200_response"
          description: Успешная аутентификация
        "404":
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Notification"
          description: Пользователь не найден
        "403":
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Notification"
          description: "Аккаунт существует, но данные неверны"
      summary: Аутентификация пользователя
      tags:
        - accounts
      x-content-type: application/json
      x-accepts:
        - application/json
  /upgrade:
    get:
      responses:
        "200":
          description: Пользователь уже получил
        "400":
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Notification"
          description: Платёжный шлюз недоступен
        "502":
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Notification"
          description: Платёжный шлюз уведомил Систему об неуспешной оплате
      security:
        - bearerAuth: [ ]
      summary: Получение статуса платного аккаунта
      tags:
        - accounts
      x-accepts:
        - application/json
  /email:
    put:
      parameters:
        - description: Идентификатор аккаунта
          explode: false
          in: path
          name: id
          required: true
          schema:
            type: string
          style: simple
      requestBody:
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/_email_put_request"
        required: true
      responses:
        "200":
          description: Почта аккаунта успешно изменена
      security:
        - bearerAuth: [ ]
      summary: Изменение почты аккаунта
      tags:
        - accounts
      x-content-type: application/json
      x-accepts:
        - application/json
  /password:
    put:
      requestBody:
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/_password_put_request"
        required: true
      responses:
        "200":
          description: Пароль успешно обновлён
      summary: Обновление пароля аккаунта
      tags:
        - accounts
      x-content-type: application/json
      x-accepts:
        - application/json
  /reset-code:
    get:
      requestBody:
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/_reset_code_get_request"
      responses:
        "200":
          description: Код отправлен на email
        "404":
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Notification"
          description: На почту не зарегистрирован ни один аккаунт
      summary: Запросить код сброса парроля на email
      tags:
        - accounts
      x-content-type: application/json
      x-accepts:
        - application/json
  /avatar:
    put:
      parameters:
        - description: Идентификатор аккаунта
          explode: false
          in: path
          name: id
          required: true
          schema:
            format: uuid
            type: string
          style: simple
      requestBody:
        content:
          multipart/form-data:
            schema:
              $ref: "#/components/schemas/_avatar_put_request"
        required: true
      responses:
        "200":
          description: Аватар успешно обновлён
      security:
        - bearerAuth: [ ]
      summary: Обновление аватара аккаунта
      tags:
        - accounts
      x-content-type: multipart/form-data
      x-accepts:
        - application/json
  /session/stage-1:
    get:
      description: Получить рандомныое значение для подтверждения подлинности Антифрода.
      responses:
        "200":
          content:
            application/json:
              schema:
                type: integer
          description: "Случайное число, которое нужно зашифровать"
      tags:
        - sessions
      x-accepts:
        - application/json
  /session/stage-2:
    post:
      requestBody:
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/_session_stage_2_post_request"
        required: true
      responses:
        "201":
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/SessionCreatedNotification"
          description: Сессия успешно создана для пользователя
        "200":
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Notification"
          description: "Идёт голосование за удаление навыка, но сессия создана и п\
            ользователь может начинать экзамен на свой риск."
        "409":
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Notification"
          description: Дважды пройти экзамен нельзя
      security:
        - bearerAuth: [ ]
      summary: Создать сессию
      tags:
        - sessions
      x-content-type: application/json
      x-accepts:
        - application/json
  /observation:
    post:
      requestBody:
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/_observation_post_request"
      responses:
        "200":
          description: Данные наблюдения загружены
      security:
        - bearerAuth: [ ]
      summary: Загрузить результат наблюдения
      tags:
        - sessions
      x-content-type: application/json
      x-accepts:
        - application/json
  /skills:
    get:
      parameters:
        - $ref: "#/components/parameters/Pagination"
        - $ref: "#/components/parameters/Filter"
      responses:
        "200":
          content:
            application/json:
              schema:
                items:
                  $ref: "#/components/schemas/Skill.response"
                type: array
          description: Успешно получен список навыков
      summary: Получение списка навыков
      tags:
        - skills
      x-accepts:
        - application/json
  /skills/{skill_id}/exams:
    get:
      parameters:
        - $ref: "#/components/parameters/Pagination"
        - $ref: "#/components/parameters/Filter"
      responses:
        "200":
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Exam.response"
          description: Успешно получен список экзаменов
      summary: Получение списка экзаменов по навыку
      tags:
        - skills
      x-accepts:
        - application/json
  /exams/{id}/solution:
    post:
      parameters:
        - description: "Идентификатор экзамена, для которой отправляется решение"
          explode: false
          in: path
          name: id
          required: true
          schema:
            format: uuid
            type: string
          style: simple
      requestBody:
        content:
          multipart/form-data:
            schema:
              $ref: "#/components/schemas/_exams__id__solution_post_request"
        required: true
      responses:
        "202":
          description: Решение успешно принято на проверку
        "200":
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Notification"
          description: "Система уведомила Пользователя об активном голосовании на\
            \ удаление навыка, предупредив, что результат по экзамена может быть у\
            дален ввиду удаления родительского навыка."
        "403":
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Notification"
          description: Нет активной сессии
      security:
        - bearerAuth: [ ]
      summary: Отправка решения экамена на проверку
      tags:
        - skills
      x-content-type: multipart/form-data
      x-accepts:
        - application/json
  /skills/{skill_id}/results:
    get:
      parameters:
        - $ref: "#/components/parameters/Pagination"
        - $ref: "#/components/parameters/Filter"
      responses:
        "200":
          content:
            application/json:
              schema:
                items:
                  $ref: "#/components/schemas/Result.response"
                type: array
          description: Список результатов успешно получен
      security:
        - bearerAuth: [ ]
      summary: Получение результатов по экзаменам навыка
      tags:
        - skills
      x-accepts:
        - application/json
  /exams/{exam_id}/result:
    get:
      parameters:
        - description: "Идентификатор экзамена, результат по которому нужно получить"
          explode: false
          in: path
          name: exam_id
          required: true
          schema:
            format: uuid
            type: string
          style: simple
      responses:
        "200":
          description: Результат получен
        "403":
          description: Уровень аккаунта не позволяет
        "404":
          description: Результат не найден (был удалён или неверная ссылка)
      security:
        - bearerAuth: [ ]
      summary: Посмотреть результат
      tags:
        - skills
      x-accepts:
        - application/json
  /votes:
    get:
      parameters:
        - $ref: "#/components/parameters/Pagination"
        - $ref: "#/components/parameters/Filter"
      responses:
        "200":
          content:
            application/json:
              schema:
                items:
                  $ref: "#/components/schemas/Vote.response"
                type: array
          description: Получены голосования
      summary: Получить список голосований
      tags:
        - votes
      x-accepts:
        - application/json
    post:
      requestBody:
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/_votes_post_request"
        required: true
      responses:
        "200":
          description: Голосование успешно создано
        "409":
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Notification"
          description: Объект голосования уже существует
      security:
        - bearerAuth: [ ]
      summary: Создать голосование
      tags:
        - votes
      x-content-type: application/json
      x-accepts:
        - application/json
  /votes/{id}/voting:
    post:
      parameters:
        - description: "Идентификатор голоса, за который отдаётся голос"
          explode: false
          in: path
          name: id
          required: true
          schema:
            format: uuid
            type: string
          style: simple
      requestBody:
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/_votes__id__voting_post_request"
        required: true
      responses:
        "200":
          description: Голос учтен
        "403":
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Notification"
          description: Авторам запрещено голосовать
      security:
        - bearerAuth: [ ]
      summary: Проголосовать
      tags:
        - votes
      x-content-type: application/json
      x-accepts:
        - application/json
  /votes/{id}/comments:
    get:
      parameters:
        - description: Идентификатор голосования
          explode: false
          in: path
          name: id
          required: true
          schema:
            format: uuid
            type: string
          style: simple
      responses:
        "200":
          content:
            application/json:
              schema:
                items:
                  $ref: "#/components/schemas/Comment.response"
                type: array
          description: Получен список комментариев
      summary: Получить комментарии к голосованию
      tags:
        - votes
      x-accepts:
        - application/json
    post:
      parameters:
        - description: Идентификатор голосования
          explode: false
          in: path
          name: id
          required: true
          schema:
            format: uuid
            type: string
          style: simple
      requestBody:
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/_votes__id__comments_post_request"
        required: true
      responses:
        "200":
          description: Комментарий успешно добавлен
      security:
        - bearerAuth: [ ]
      summary: Добавление комментария к голосованию
      tags:
        - votes
      x-content-type: application/json
      x-accepts:
        - application/json
  /votes/{vote_id}/comments/{comment_id}:
    delete:
      parameters:
        - description: Идентификатор голосования
          explode: false
          in: path
          name: vote_id
          required: true
          schema:
            format: uuid
            type: string
          style: simple
        - description: Идентификатор комментария
          explode: false
          in: path
          name: comment_id
          required: true
          schema:
            format: uuid
            type: string
          style: simple
      responses:
        "200":
          description: Комментарий успешно удалён
        "401":
          description: Вы не автор комментария!
      security:
        - bearerAuth: [ ]
      summary: Удаление комментария к голосованию
      tags:
        - votes
      x-accepts:
        - application/json
    put:
      parameters:
        - description: Идентификатор голосования
          explode: false
          in: path
          name: vote_id
          required: true
          schema:
            format: uuid
            type: string
          style: simple
        - description: Идентификатор комментария
          explode: false
          in: path
          name: comment_id
          required: true
          schema:
            format: uuid
            type: string
          style: simple
      responses:
        "200":
          description: Комментарий успешно отредактирован
        "401":
          description: Вы не автор комментария!
      security:
        - bearerAuth: [ ]
      summary: Редактирование комментария к голосованию
      tags:
        - votes
      x-accepts:
        - application/json
  /notifications:
    delete:
      responses:
        "200":
          description: Уведомления удалены
      security:
        - bearerAuth: [ ]
      summary: Пометить уведомления прочитанными
      tags:
        - notifications
      x-accepts:
        - application/json
    get:
      parameters:
        - $ref: "#/components/parameters/Pagination"
      responses:
        "200":
          content:
            application/json:
              schema:
                items:
                  $ref: "#/components/schemas/Notification"
                type: array
          description: Список уведомлений успешно получен
      security:
        - bearerAuth: [ ]
      summary: Получение уведомлений
      tags:
        - notifications
      x-accepts:
        - application/json
components:
  parameters:
    Filter:
      explode: true
      in: query
      name: filter
      required: false
      schema:
        $ref: "#/components/schemas/Filter"
      style: form
    Pagination:
      explode: true
      in: query
      name: pagination
      required: true
      schema:
        $ref: "#/components/schemas/Pagination"
      style: form
  schemas:
    Filter:
      properties:
        field:
          description: Название фильтруемого поля
          type: string
        predicate:
          $ref: "#/components/schemas/Filter_predicate"
      required:
        - field
        - predicate
    Pagination:
      properties:
        page:
          description: Номер страницы
          minimum: 1
          type: integer
        size:
          description: Количество элементов на странице
          maximum: 100
          minimum: 1
          type: integer
      required:
        - page
        - size
    Skill.response:
      example:
        name: name
        vote_id: 046b6c7f-0b8a-43b9-b35d-6489e6daee91
      properties:
        name:
          description: Название навыка
          type: string
        vote_id:
          description: "ID голосования, в результате которого навык был добавлен в\
            \ систему."
          format: uuid
          type: string
      required:
        - name
        - vote_id
    Exam.response:
      example:
        session: 046b6c7f-0b8a-43b9-b35d-6489e6daee91
        name: name
        desc: desc
      properties:
        name:
          type: string
        desc:
          type: string
        session:
          format: uuid
          type: string
    Result.response:
      example:
        exam_name: 046b6c7f-0b8a-43b9-b35d-6489e6daee91
        exam_id: 046b6c7f-0b8a-43b9-b35d-6489e6daee91
      properties:
        exam_id:
          description: "ID экзамена, по которой получен результат"
          format: uuid
          type: string
        exam_name:
          description: "Название экзамена, по которой получен результат"
          format: uuid
          type: string
    Vote:
      properties:
        action:
          enum:
            - delete_skill
            - add_skill
            - add_exam
          type: string
        arguments:
          description: "Аргументы за совершение действия, предложенного в голосова\
            нии."
          type: string
    SkillAddVote:
      allOf:
        - $ref: "#/components/schemas/Vote"
        - properties:
            name:
              description: Наименование навыка
              type: string
    SkillDelVote:
      allOf:
        - $ref: "#/components/schemas/Vote"
        - properties:
            id:
              description: Идентификатор навыка
              format: uuid
              type: string
    ExamAddVote:
      allOf:
        - $ref: "#/components/schemas/Vote"
        - properties:
            skill_id:
              description: "Идентификатор навыка, для проверки которого создан экзам\
              ен"
              format: uuid
              type: string
            name:
              description: Название экзамена работы
              type: string
            arguments:
              description: "Пояснение для людей, почему эта экзамен важен"
              type: string
            desc:
              description: Финальная постановка задания для экзаменуемых
              type: string
            material:
              description: Архив проекта с автотестами
              format: binary
              type: string
          required:
            - arguments
            - desc
            - material
            - name
            - skill_id
    Vote.response:
      allOf:
        - $ref: "#/components/schemas/Vote"
        - properties:
            votes:
              $ref: "#/components/schemas/Vote_response_allOf_votes"
            expire_at:
              description: "Конечный срок, когда голосование закроется, будет подсчи\
              тан результат и совершенно действие."
              example: 2025-12-31T23:59:59Z
              format: date-time
              type: string
      example:
        action: delete_skill
        arguments: arguments
        votes:
          negative: 6
          positive: 0
        expire_at: 2025-12-31T23:59:59Z
    Comment.response:
      example:
        author: ""
        comment: comment
      properties:
        author:
          allOf:
            - $ref: "#/components/schemas/Profile.response"
          description: Автор комментария
        comment:
          description: Содержимое
          type: string
    Profile.response:
      properties:
        id:
          description: Id профиля
          example: d8cbb1f0-f4eb-46b4-b1b6-c0a670544254
          format: uuid
          type: string
        avatar_url:
          description: URL на аватар профиля
          type: string
        username:
          description: Отображаемое имя профиля
          type: string
    Notification:
      description: Уведомление о событии в системе
      example:
        level: error
        created_at: 2000-01-23T04:56:07.000+00:00
        message: message
      properties:
        level:
          enum:
            - error
            - warning
            - info
          type: string
        message:
          description: "Содержимое, может содержать разметку"
          type: string
        created_at:
          format: date-time
          type: string
    SessionCreatedNotification:
      example:
        notification:
          level: error
          created_at: 2000-01-23T04:56:07.000+00:00
          message: message
        hash: hash
      properties:
        notification:
          $ref: "#/components/schemas/Notification"
        hash:
          description: hash(notification)
          type: string
    _accounts_post_request:
      properties:
        login:
          type: string
        email:
          description: Для восстановления пароля и рассылок
          type: string
        password:
          type: string
        consent_personal_data:
          description: Согласен ли пользователь на обработку персональных данных
          type: boolean
        username:
          description: Отображаемое имя профиля
          type: string
    _auth_get_request:
      properties:
        login:
          type: string
        password:
          type: string
      required:
        - login
        - password
    _auth_get_200_response:
      example:
        token: token
      properties:
        token:
          type: string
    _email_put_request:
      properties:
        email:
          description: новая почта аккаунта
          type: string
      required:
        - email
    _password_put_request:
      properties:
        reset_code:
          description: "токен для сброса пароля, отправленный пользователю на почт\
            у"
          type: string
        new_password:
          type: string
        login:
          description: "логин аккаунта, пароль от которого надо сбросить"
          type: string
      required:
        - login
        - new_password
        - reset_code
    _reset_code_get_request:
      properties:
        email:
          type: string
    _avatar_put_request:
      properties:
        avatar:
          format: binary
          type: string
      required:
        - avatar
    _session_stage_2_post_request:
      properties:
        exam_id:
          description: Идентификатор экзамена
          format: uuid
          type: string
        cipher:
          description: "Зашифрованное случайное число, полученное ранее."
          type: integer
    _observation_post_request_observation:
      properties:
        violations:
          description: "Какие запрещённые действия пользователь совершал. Если ука\
            зано, значит совершал."
          items:
            enum:
              - remote_control
              - clipboard
              - web
            type: string
            x-enum-descriptions:
              - к пк экзаминуемого подключались по протоколам удалённого рабочего стола
              - замечено вставка решения из буфера обмена
              - замечено испльзование интернет-ресурсов для поиска ответов
          type: array
    _observation_post_request:
      properties:
        observation:
          $ref: "#/components/schemas/_observation_post_request_observation"
        mac:
          description: "Message Authentication Code, состоящее из Observation и ши\
            фрованного хеша Observation"
          type: string
    _exams__id__solution_post_request:
      properties:
        solution:
          description: Архив с решением (загружается как файл)
          format: binary
          type: string
      required:
        - solution
    _votes_post_request:
      discriminator:
        mapping:
          add_skill: "#/components/schemas/SkillAddVote"
          delete_skill: "#/components/schemas/SkillDelVote"
          add_exam: "#/components/schemas/ExamAddVote"
        propertyName: action
      oneOf:
        - $ref: "#/components/schemas/SkillAddVote"
        - $ref: "#/components/schemas/SkillDelVote"
        - $ref: "#/components/schemas/ExamAddVote"
    _votes__id__voting_post_request:
      properties:
        reaction:
          description: |
            +1 — за,
            -1 — против
          enum:
            - 1
            - -1
          type: string
      required:
        - reaction
    _votes__id__comments_post_request:
      properties:
        comment:
          description: содержимое
          type: string
      required:
        - comment
    Filter_predicate:
      properties:
        operator:
          description: Применяемый оператор
          enum:
            - NOT
            - EQ
            - NOT_EQ
            - AND
            - OR
            - LIKE
          type: string
        value:
          description: Правый операнд
          type: string
      required:
        - operator
        - value
    Vote_response_allOf_votes:
      description: Голоса
      example:
        negative: 6
        positive: 0
      properties:
        positive:
          type: integer
        negative:
          type: integer
  securitySchemes:
    bearerAuth:
      scheme: bearer
      type: http
